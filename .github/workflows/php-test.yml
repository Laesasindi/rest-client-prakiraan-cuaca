name: PHP Testing Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [7.4, 8.0, 8.1, 8.2]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring, curl
        coverage: xdebug
    
    - name: Validate composer.json and composer.lock
      run: composer validate --strict
      continue-on-error: true
    
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-
    
    - name: Install dependencies
      run: |
        if [ -f composer.json ]; then
          composer install --prefer-dist --no-progress
        else
          # Install PHPUnit manually if no composer.json
          wget https://phar.phpunit.de/phpunit-9.phar
          chmod +x phpunit-9.phar
          sudo mv phpunit-9.phar /usr/local/bin/phpunit
        fi
    
    - name: Check PHP syntax
      run: |
        find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
    
    - name: Run PHPUnit tests
      env:
        WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
      run: |
        if [ -f vendor/bin/phpunit ]; then
          vendor/bin/phpunit --coverage-text
        else
          phpunit --coverage-text
        fi
    
    - name: Check HTML validity
      run: |
        echo "Checking HTML structure..."
        
        # Check if main files exist and have basic structure
        if [ ! -f "index.php" ]; then
          echo "ERROR: index.php not found"
          exit 1
        fi
        
        if [ ! -f "config.php" ]; then
          echo "ERROR: config.php not found"
          exit 1
        fi
        
        # Check for basic HTML structure in index.php
        if ! grep -q "<!DOCTYPE html>" index.php; then
          echo "ERROR: Missing DOCTYPE declaration in index.php"
          exit 1
        fi
        
        echo "HTML structure validation passed"
    
    - name: Security check
      run: |
        # Check for potential security issues
        echo "Checking for potential security issues..."
        
        # Check if API keys are not hardcoded
        if grep -r "sk-" . --exclude-dir=vendor --exclude-dir=.git; then
          echo "WARNING: Potential API key found in code"
        fi
        
        # Check for SQL injection patterns
        if grep -r "SELECT.*\$_" . --exclude-dir=vendor --exclude-dir=.git; then
          echo "WARNING: Potential SQL injection vulnerability"
        fi
        
        echo "Security check completed"
    
    - name: Performance test
      run: |
        echo "Running basic performance test..."
        time php -r "
        for (\$i = 0; \$i < 100; \$i++) {
          include_once 'config.php';
        }
        echo 'Performance test completed';
        "

  deploy-check:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
    
    - name: Check deployment readiness
      run: |
        echo "Checking deployment readiness..."
        
        # Check if all required files exist
        required_files=("index.php" "config.php" "pages/search.php" "pages/map.php" "pages/geography.php")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file $file is missing"
            exit 1
          fi
        done
        
        # Check if API configuration is ready
        if ! grep -q "WEATHER_API_KEY" config.php; then
          echo "ERROR: API key configuration is missing"
          exit 1
        fi
        
        echo "Deployment readiness check passed"